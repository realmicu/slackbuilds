From b8c3c7aa1920eb7e60e2cd14bbedb6b8674c1c31 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Tue, 15 Dec 2020 18:17:00 +0100
Subject: [PATCH] backport drm_prime_pages_to_sg_has_drm_device_arg changes
 from 455.45.01

---
 conftest.sh                             | 24 ++++++++++++++++++++++++
 nvidia-drm/nvidia-drm-gem-user-memory.c |  7 +++++--
 nvidia-drm/nvidia-drm-helper.h          | 15 +++++++++++++++
 nvidia-drm/nvidia-drm.Kbuild            |  1 +
 4 files changed, 45 insertions(+), 2 deletions(-)

--- a/conftest.sh
+++ b/conftest.sh
@@ -4280,6 +4280,30 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_VGA_TRYGET_PRESENT" "" "functions"
         ;;
 
+        drm_prime_pages_to_sg_has_drm_device_arg)
+            #
+            # Determine if drm_prime_pages_to_sg() has 'dev' argument.
+            #
+            # drm_prime_pages_to_sg() is updated to take 'dev' argument by commit
+            # 707d561f77b5 ("drm: allow limiting the scatter list size.").
+            #
+            CODE="
+            #if defined(NV_DRM_DRMP_H_PRESENT)
+            #include <drm/drmP.h>
+            #endif
+            #if defined(NV_DRM_DRM_PRIME_H_PRESENT)
+            #include <drm/drm_prime.h>
+            #endif
+
+            struct sg_table *drm_prime_pages_to_sg(struct drm_device *dev,
+                                                   struct page **pages,
+                                                   unsigned int nr_pages) {
+                return 0;
+            }"
+
+            compile_check_conftest "$CODE" "NV_DRM_PRIME_PAGES_TO_SG_HAS_DRM_DEVICE_ARG" "" "types"
+        ;;
+
     esac
 }
 
--- a/nvidia-drm/nvidia-drm-gem-user-memory.c
+++ b/nvidia-drm/nvidia-drm-gem-user-memory.c
@@ -29,6 +29,7 @@
 #endif
 
 #include "nvidia-drm-gem-user-memory.h"
+#include "nvidia-drm-helper.h"
 #include "nvidia-drm-ioctl.h"
 
 static inline
@@ -46,9 +47,11 @@ static struct sg_table *__nv_drm_gem_use
     struct nv_drm_gem_object *nv_gem)
 {
     struct nv_drm_gem_user_memory *nv_user_memory = to_nv_user_memory(nv_gem);
+    struct drm_gem_object *gem = &nv_gem->base;
 
-    return drm_prime_pages_to_sg(nv_user_memory->pages,
-                                 nv_user_memory->pages_count);
+    return nv_drm_prime_pages_to_sg(gem->dev,
+                                    nv_user_memory->pages,
+                                    nv_user_memory->pages_count);
 }
 
 static void *__nv_drm_gem_user_memory_prime_vmap(
--- a/nvidia-drm/nvidia-drm-helper.h
+++ b/nvidia-drm/nvidia-drm-helper.h
@@ -55,6 +55,21 @@ static inline void nv_drm_dev_free(struc
 #endif
 }
 
+#if defined(NV_DRM_DRM_PRIME_H_PRESENT)
+#include <drm/drm_prime.h>
+#endif
+
+static inline struct sg_table*
+nv_drm_prime_pages_to_sg(struct drm_device *dev,
+                         struct page **pages, unsigned int nr_pages)
+{
+#if defined(NV_DRM_PRIME_PAGES_TO_SG_HAS_DRM_DEVICE_ARG)
+    return drm_prime_pages_to_sg(dev, pages, nr_pages);
+#else
+    return drm_prime_pages_to_sg(pages, nr_pages);
+#endif
+}
+
 #if defined(NV_DRM_ATOMIC_MODESET_AVAILABLE)
 
 /*
--- a/nvidia-drm/nvidia-drm.Kbuild
+++ b/nvidia-drm/nvidia-drm.Kbuild
@@ -97,3 +97,4 @@ NV_CONFTEST_TYPE_COMPILE_TESTS += mm_has
 NV_CONFTEST_TYPE_COMPILE_TESTS += drm_display_mode_has_vrefresh
 NV_CONFTEST_TYPE_COMPILE_TESTS += drm_driver_master_set_has_int_return_type
 NV_CONFTEST_TYPE_COMPILE_TESTS += drm_driver_has_gem_free_object
+NV_CONFTEST_TYPE_COMPILE_TESTS += drm_prime_pages_to_sg_has_drm_device_arg
