From c848c7f19d19b093f28deca139013f802017f448 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Tue, 15 Dec 2020 17:09:29 +0100
Subject: [PATCH 2/2] backport get_dma_ops changes from 455.45.01

---
 common/inc/nv-linux.h |  4 ++++
 conftest.sh           | 17 +++++++++++++++++
 2 files changed, 21 insertions(+)

--- a/common/inc/nv-linux.h
+++ b/common/inc/nv-linux.h
@@ -179,6 +179,10 @@ static inline uid_t __kuid_val(kuid_t ui
 #include <linux/dma-mapping.h>
 #endif
 
+#if defined(NV_LINUX_DMA_MAP_OPS_H_PRESENT)
+#include <linux/dma-map-ops.h>
+#endif
+
 #if defined(CONFIG_SWIOTLB) && defined(NVCPU_AARCH64)
 #include <linux/swiotlb.h>
 #endif
--- a/conftest.sh
+++ b/conftest.sh
@@ -134,6 +134,7 @@ test_headers() {
     FILES="$FILES linux/fence.h"
     FILES="$FILES linux/ktime.h"
     FILES="$FILES linux/dma-resv.h"
+    FILES="$FILES linux/dma-map-ops.h"
 
     # Arch specific headers which need testing
     FILES_ARCH="asm/book3s/64/hash-64k.h"
@@ -2064,7 +2065,11 @@ compile_test() {
             # Determine if the 'dma_ops' structure is present.
             #
             CODE="
+            #if defined(NV_LINUX_DMA_MAP_OPS_H_PRESENT)
+            #include <linux/dma-map-ops.h>
+            #else
             #include <linux/dma-mapping.h>
+            #endif
             void conftest_dma_ops(void) {
                 (void)dma_ops;
             }"
@@ -2091,7 +2096,11 @@ compile_test() {
             # Determine if the 'struct dma_map_ops' type is present.
             # 
             CODE="
+            #if defined(NV_LINUX_DMA_MAP_OPS_H_PRESENT)
+            #include <linux/dma-map-ops.h>
+            #else
             #include <linux/dma-mapping.h>
+            #endif
             void conftest_dma_map_ops(void) {
                 struct dma_map_ops ops;
             }"
@@ -2103,8 +2112,16 @@ compile_test() {
             #
             # Determine if the get_dma_ops() function is present.
             #
+            # Commit 0a0f0d8be76d ("dma-mapping: split <linux/dma-mapping.h>")
+            # in v5.10-rc1 (2020-09-22), moved get_dma_ops() function
+            # prototype from <linux/dma-mapping.h> to <linux/dma-map-ops.h>.
+            #
             CODE="
+            #if defined(NV_LINUX_DMA_MAP_OPS_H_PRESENT)
+            #include <linux/dma-map-ops.h>
+            #else
             #include <linux/dma-mapping.h>
+            #endif
             void conftest_get_dma_ops(void) {
                 get_dma_ops();
             }"
